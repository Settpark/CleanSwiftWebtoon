//
//  WebtoonHomeViewController.swift
//  CleanWebtoon
//
//  Created by temp_name on 2023/06/21.
//  Copyright (c) 2023 ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol WebtoonHomeDisplayLogic: AnyObject {
    func displayWebtoonList(viewModels: [WebtoonHome.WebtoonList.ViewModel], updateDay: UpdateDay)
    func displayRecommandWebtoon(viewModels: [WebtoonHome.WebtoonList.ViewModel])
    func setupTodayWebtoonlist(offset: CGFloat)
}

class WebtoonHomeViewController: UIViewController, WebtoonHomeDisplayLogic {
    
    var interactor: WebtoonHomeBusinessLogic?
    var router: (NSObjectProtocol & WebtoonHomeRoutingLogic & WebtoonHomeDataPassing)?
    
    private let mainScrollView: UIScrollView
    private let mainScrollStackView: UIStackView
    private let topEventScrollView: UIScrollView
    
    private let weekDayScrollView: UIScrollView
    private let weekDayStackView: UIStackView
    
    private let newWebtoonButton: UIButton
    private let everydayPlusButton: UIButton
    private let mondayButton: UIButton
    private let tuesdayButton: UIButton
    private let wednesdayButton: UIButton
    private let thursdayButton: UIButton
    private let fridayButton: UIButton
    private let saturdayButton: UIButton
    private let sundayButton: UIButton
    private let finishButton: UIButton
    
    private let webtoonListScrollView: UIScrollView
    private let webtoonListStackView: UIStackView
    private let newWebtoonCollection: UICollectionView
    private let everyDayPlusWebtoonCollection: UICollectionView
    private let mondayWebtoonCollection: UICollectionView
    private let tuesdayWebtoonCollection: UICollectionView
    private let wednesdayWebtoonCollection: UICollectionView
    private let thursdayWebtoonCollection: UICollectionView
    private let fridayWebtoonCollection: UICollectionView
    private let saturdayWebtoonCollection: UICollectionView
    private let sundayWebtoonCollection: UICollectionView
    private let finishWebtoonCollection: UICollectionView
    
    private let webtoonListLayout: WebtoonListLayout
    private let newWebtoonDataSource: WebtoonListDataSource
    private let everyDayPlusWebtoonDataSource: WebtoonListDataSource
    private let mondayWebtoonDataSource: WebtoonListDataSource
    private let tuesdayWebtoonDataSource: WebtoonListDataSource
    private let wednesdayWebtoonDataSource: WebtoonListDataSource
    private let thursdayWebtoonDataSource: WebtoonListDataSource
    private let fridayWebtoonDataSource: WebtoonListDataSource
    private let saturdayWebtoonDataSource: WebtoonListDataSource
    private let sundayWebtoonDataSource: WebtoonListDataSource
    private let finishWebtoonDataSource: WebtoonListDataSource
    
    private let webtoonListScrollDelegate: WebtoonListScrollDelegate
    private let topEventStackView: UIStackView
    private var currentCollectionHeightConstraint: NSLayoutConstraint?
    
    private let mondayWebtoonDiffableDatasource: (DiffableDatasourceManagable &
                                                  UICollectionViewDelegate &
                                                  UICollectionViewDelegateFlowLayout)
    
    override init(nibName nibNameOrNil: String?, bundle nibBundleOrNil: Bundle?) {
        mainScrollView = {
            let scrollView = UIScrollView()
            scrollView.translatesAutoresizingMaskIntoConstraints = false
            scrollView.showsVerticalScrollIndicator = false
            scrollView.bounces = false
            scrollView.bounces = false
            return scrollView
        }()
        mainScrollStackView = {
            let stackView = UIStackView()
            stackView.translatesAutoresizingMaskIntoConstraints = false
            stackView.axis = .vertical
            stackView.distribution = .equalSpacing
            stackView.spacing = 10
            return stackView
        }()
        topEventScrollView = {
            let scrollView = UIScrollView()
            scrollView.translatesAutoresizingMaskIntoConstraints = false
            scrollView.showsHorizontalScrollIndicator = false
            scrollView.bounces = false
            scrollView.isPagingEnabled = true
            return scrollView
        }()
        topEventStackView = {
            let stackView = UIStackView()
            stackView.translatesAutoresizingMaskIntoConstraints = false
            stackView.axis = .horizontal
            return stackView
        }()
        weekDayScrollView = {
            let scrollView = UIScrollView()
            scrollView.translatesAutoresizingMaskIntoConstraints = false
            scrollView.bounces = false
            scrollView.showsHorizontalScrollIndicator = false
            return scrollView
        }()
        weekDayStackView = {
            let stackView = UIStackView()
            stackView.translatesAutoresizingMaskIntoConstraints = false
            stackView.spacing = 10
            stackView.distribution = .equalSpacing
            stackView.axis = .horizontal
            return stackView
        }()
        newWebtoonButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("신작", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        everydayPlusButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("매일+", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        mondayButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("월", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        tuesdayButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("화", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        wednesdayButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("수", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        thursdayButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("목", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        fridayButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("금", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        saturdayButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("토", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        sundayButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("일", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        finishButton = {
            let button = UIButton()
            button.translatesAutoresizingMaskIntoConstraints = false
            button.setTitle("완결", for: .normal)
            button.titleLabel?.font = .systemFont(ofSize: 13)
            button.setTitleColor(.black, for: .normal)
            return button
        }()
        webtoonListScrollView = {
            let scrollView = UIScrollView()
            scrollView.translatesAutoresizingMaskIntoConstraints = false
            scrollView.isPagingEnabled = true
            return scrollView
        }()
        webtoonListStackView = {
            let stackView = UIStackView()
            stackView.translatesAutoresizingMaskIntoConstraints = false
            stackView.axis = .horizontal
            return stackView
        }()
        newWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        everyDayPlusWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        mondayWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        tuesdayWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        wednesdayWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        thursdayWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        fridayWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        saturdayWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        sundayWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        finishWebtoonCollection = {
            let layout = UICollectionViewFlowLayout()
            layout.sectionInset = UIEdgeInsets(top: 0, left: 20, bottom: 0, right: 20)
            let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
            collectionView.isUserInteractionEnabled = false
            collectionView.translatesAutoresizingMaskIntoConstraints = false
            return collectionView
        }()
        webtoonListLayout = WebtoonListLayout(inset: 20)
        newWebtoonDataSource = WebtoonListDataSource()
        everyDayPlusWebtoonDataSource = WebtoonListDataSource()
        mondayWebtoonDataSource = WebtoonListDataSource()
        tuesdayWebtoonDataSource = WebtoonListDataSource()
        wednesdayWebtoonDataSource = WebtoonListDataSource()
        thursdayWebtoonDataSource = WebtoonListDataSource()
        fridayWebtoonDataSource = WebtoonListDataSource()
        saturdayWebtoonDataSource = WebtoonListDataSource()
        sundayWebtoonDataSource = WebtoonListDataSource()
        finishWebtoonDataSource = WebtoonListDataSource()
        
        webtoonListScrollDelegate = WebtoonListScrollDelegate()
        webtoonListScrollView.delegate = webtoonListScrollDelegate
        
        currentCollectionHeightConstraint = nil
        
        mondayWebtoonDiffableDatasource = WebtoonListDiffableDatasourceManager(inset: 20)
        
        super.init(nibName: nibNameOrNil, bundle: nibBundleOrNil)
        setup()
        setupDataSource()
        setupWebtoonScrollDelegate()
        setupViews()
    }
    
    required init?(coder aDecoder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    // MARK: Setup
    private func setup() {
        let viewController = self
        let interactor = WebtoonHomeInteractor()
        let presenter = WebtoonHomePresenter()
        let router = WebtoonHomeRouter()
        viewController.interactor = interactor
        viewController.router = router
        interactor.presenter = presenter
        presenter.viewController = viewController
        router.viewController = viewController
        router.dataStore = interactor
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        fetchTodayWebtoon()
        setupButtonFeature()
    }
    
    override func viewDidLayoutSubviews() {
        super.viewDidLayoutSubviews()
        self.applyTopEventGradient()
    }
    
    private func setupViews() {
        title = "웹툰"
        tabBarItem = UITabBarItem(title: "웹툰", image: UIImage(systemName: "house"), selectedImage: UIImage(systemName: "house.fill"))
        view.backgroundColor = .white
        
        view.addSubview(mainScrollView)
        mainScrollView.addSubview(mainScrollStackView)
        mainScrollStackView.addArrangedSubview(topEventScrollView)
        
        topEventScrollView.addSubview(topEventStackView)
        
        mainScrollStackView.addArrangedSubview(weekDayScrollView)
        weekDayScrollView.addSubview(weekDayStackView)
        let leadingPaddingView: UIView = {
            let view = UIView()
            view.translatesAutoresizingMaskIntoConstraints = false
            NSLayoutConstraint.activate([
                view.widthAnchor.constraint(equalToConstant: 1)
            ])
            return view
        }()
        let trailingPaddingView: UIView = {
            let view = UIView()
            view.translatesAutoresizingMaskIntoConstraints = false
            NSLayoutConstraint.activate([
                view.widthAnchor.constraint(equalToConstant: 1)
            ])
            return view
        }()
        weekDayStackView.addArrangedSubview(leadingPaddingView)
        weekDayStackView.addArrangedSubview(newWebtoonButton)
        weekDayStackView.addArrangedSubview(everydayPlusButton)
        weekDayStackView.addArrangedSubview(mondayButton)
        weekDayStackView.addArrangedSubview(tuesdayButton)
        weekDayStackView.addArrangedSubview(wednesdayButton)
        weekDayStackView.addArrangedSubview(thursdayButton)
        weekDayStackView.addArrangedSubview(fridayButton)
        weekDayStackView.addArrangedSubview(saturdayButton)
        weekDayStackView.addArrangedSubview(sundayButton)
        weekDayStackView.addArrangedSubview(finishButton)
        weekDayStackView.addArrangedSubview(trailingPaddingView)
        mainScrollStackView.addArrangedSubview(webtoonListScrollView)
        webtoonListScrollView.addSubview(webtoonListStackView)
        
        let newWebtoonStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let everyDayPlusStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let mondayStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let tuesdayStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let wednesdayStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let thursdayStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let fridayStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let saturdayStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let sundayStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        let finishStackView: UIStackView = {
            let stackView = UIStackView()
            stackView.axis = .vertical
            stackView.translatesAutoresizingMaskIntoConstraints = false
            return stackView
        }()
        
        webtoonListStackView.addArrangedSubview(newWebtoonStackView)
        newWebtoonStackView.addArrangedSubview(newWebtoonCollection)
        webtoonListStackView.addArrangedSubview(everyDayPlusStackView)
        everyDayPlusStackView.addArrangedSubview(everyDayPlusWebtoonCollection)
        webtoonListStackView.addArrangedSubview(mondayStackView)
        mondayStackView.addArrangedSubview(mondayWebtoonCollection)
        webtoonListStackView.addArrangedSubview(tuesdayStackView)
        tuesdayStackView.addArrangedSubview(tuesdayWebtoonCollection)
        webtoonListStackView.addArrangedSubview(wednesdayStackView)
        wednesdayStackView.addArrangedSubview(wednesdayWebtoonCollection)
        webtoonListStackView.addArrangedSubview(thursdayStackView)
        thursdayStackView.addArrangedSubview(thursdayWebtoonCollection)
        webtoonListStackView.addArrangedSubview(fridayStackView)
        fridayStackView.addArrangedSubview(fridayWebtoonCollection)
        webtoonListStackView.addArrangedSubview(saturdayStackView)
        saturdayStackView.addArrangedSubview(saturdayWebtoonCollection)
        webtoonListStackView.addArrangedSubview(sundayStackView)
        sundayStackView.addArrangedSubview(sundayWebtoonCollection)
        webtoonListStackView.addArrangedSubview(finishStackView)
        finishStackView.addArrangedSubview(finishWebtoonCollection)
        
        NSLayoutConstraint.activate([
            mainScrollView.topAnchor.constraint(equalTo: view.topAnchor),
            mainScrollView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            mainScrollView.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            mainScrollView.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor),
            
            mainScrollStackView.topAnchor.constraint(equalTo: mainScrollView.contentLayoutGuide.topAnchor),
            mainScrollStackView.leadingAnchor.constraint(equalTo: mainScrollView.contentLayoutGuide.leadingAnchor),
            mainScrollStackView.trailingAnchor.constraint(equalTo: mainScrollView.contentLayoutGuide.trailingAnchor),
            mainScrollStackView.bottomAnchor.constraint(equalTo: mainScrollView.contentLayoutGuide.bottomAnchor),
            mainScrollStackView.widthAnchor.constraint(equalTo: mainScrollView.frameLayoutGuide.widthAnchor),
            
            topEventStackView.topAnchor.constraint(equalTo: topEventScrollView.contentLayoutGuide.topAnchor),
            topEventStackView.leadingAnchor.constraint(equalTo: topEventScrollView.contentLayoutGuide.leadingAnchor),
            topEventStackView.trailingAnchor.constraint(equalTo: topEventScrollView.contentLayoutGuide.trailingAnchor),
            topEventStackView.bottomAnchor.constraint(equalTo: topEventScrollView.contentLayoutGuide.bottomAnchor),
            topEventStackView.heightAnchor.constraint(equalTo: topEventScrollView.frameLayoutGuide.heightAnchor),
            
            weekDayScrollView.heightAnchor.constraint(equalToConstant: 20),
            weekDayScrollView.leadingAnchor.constraint(equalTo: self.view.safeAreaLayoutGuide.leadingAnchor),
            weekDayScrollView.trailingAnchor.constraint(equalTo: self.view.safeAreaLayoutGuide.trailingAnchor),
            
            weekDayStackView.leadingAnchor.constraint(equalTo: weekDayScrollView.contentLayoutGuide.leadingAnchor),
            weekDayStackView.trailingAnchor.constraint(equalTo: weekDayScrollView.contentLayoutGuide.trailingAnchor),
            weekDayStackView.topAnchor.constraint(equalTo: weekDayScrollView.contentLayoutGuide.topAnchor),
            weekDayStackView.bottomAnchor.constraint(equalTo: weekDayScrollView.contentLayoutGuide.bottomAnchor),
            weekDayStackView.heightAnchor.constraint(equalTo: weekDayScrollView.frameLayoutGuide.heightAnchor),
            
            newWebtoonButton.widthAnchor.constraint(equalToConstant: 35),
            newWebtoonButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            everydayPlusButton.widthAnchor.constraint(equalToConstant: 35),
            everydayPlusButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            mondayButton.widthAnchor.constraint(equalToConstant: 30),
            mondayButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            tuesdayButton.widthAnchor.constraint(equalToConstant: 30),
            tuesdayButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            wednesdayButton.widthAnchor.constraint(equalToConstant: 30),
            wednesdayButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            thursdayButton.widthAnchor.constraint(equalToConstant: 30),
            thursdayButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            fridayButton.widthAnchor.constraint(equalToConstant: 30),
            fridayButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            saturdayButton.widthAnchor.constraint(equalToConstant: 30),
            saturdayButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            sundayButton.widthAnchor.constraint(equalToConstant: 30),
            sundayButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            finishButton.widthAnchor.constraint(equalToConstant: 35),
            finishButton.heightAnchor.constraint(equalTo: self.weekDayStackView.heightAnchor),
            
            webtoonListStackView.leadingAnchor.constraint(equalTo: webtoonListScrollView.contentLayoutGuide.leadingAnchor),
            webtoonListStackView.trailingAnchor.constraint(equalTo: webtoonListScrollView.contentLayoutGuide.trailingAnchor),
            webtoonListStackView.topAnchor.constraint(equalTo: webtoonListScrollView.contentLayoutGuide.topAnchor),
            webtoonListStackView.bottomAnchor.constraint(equalTo: webtoonListScrollView.contentLayoutGuide.bottomAnchor),
            webtoonListStackView.heightAnchor.constraint(equalTo: webtoonListScrollView.frameLayoutGuide.heightAnchor),
            
            newWebtoonCollection.widthAnchor.constraint(equalTo: self.view.safeAreaLayoutGuide.widthAnchor),
            everyDayPlusWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor),
            mondayWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor),
            tuesdayWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor),
            wednesdayWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor),
            thursdayWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor),
            fridayWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor),
            saturdayWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor),
            sundayWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor),
            finishWebtoonCollection.widthAnchor.constraint(equalTo: view.safeAreaLayoutGuide.widthAnchor)
        ])
    }
    
    private func setupDataSource() {
        newWebtoonCollection.delegate = webtoonListLayout
        newWebtoonCollection.dataSource = newWebtoonDataSource
        newWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        everyDayPlusWebtoonCollection.delegate = webtoonListLayout
        everyDayPlusWebtoonCollection.dataSource = everyDayPlusWebtoonDataSource
        everyDayPlusWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        mondayWebtoonCollection.delegate = mondayWebtoonDiffableDatasource
//        mondayWebtoonCollection.dataSource = mondayWebtoonDataSource
        mondayWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        mondayWebtoonDiffableDatasource.bindingDatasource(collectionView: mondayWebtoonCollection)
        mondayWebtoonCollection.dataSource = mondayWebtoonDiffableDatasource.diffableDatasource
        tuesdayWebtoonCollection.delegate = webtoonListLayout
        tuesdayWebtoonCollection.dataSource = tuesdayWebtoonDataSource
        tuesdayWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        wednesdayWebtoonCollection.delegate = webtoonListLayout
        wednesdayWebtoonCollection.dataSource = wednesdayWebtoonDataSource
        wednesdayWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        thursdayWebtoonCollection.delegate = webtoonListLayout
        thursdayWebtoonCollection.dataSource = thursdayWebtoonDataSource
        thursdayWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        fridayWebtoonCollection.delegate = webtoonListLayout
        fridayWebtoonCollection.dataSource = fridayWebtoonDataSource
        fridayWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        saturdayWebtoonCollection.delegate = webtoonListLayout
        saturdayWebtoonCollection.dataSource = saturdayWebtoonDataSource
        saturdayWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        sundayWebtoonCollection.delegate = webtoonListLayout
        sundayWebtoonCollection.dataSource = sundayWebtoonDataSource
        sundayWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
        finishWebtoonCollection.delegate = webtoonListLayout
        finishWebtoonCollection.dataSource = finishWebtoonDataSource
        finishWebtoonCollection.register(WebtoonListCell.self, forCellWithReuseIdentifier: WebtoonListCell.identifier)
    }
    
    private func setupMainStackViewSpacing() {
        mainScrollStackView.setCustomSpacing(5, after: topEventScrollView)
    }
    
    func setupWebtoonScrollDelegate() {
        self.webtoonListScrollDelegate.listner = self
    }
    
    func setupTodayWebtoonlist(offset: CGFloat) {
        disableAllButton()
        DispatchQueue.main.async {
            let scrollOffset = offset * self.view.frame.width
            self.webtoonListScrollView.setContentOffset(CGPoint(x: scrollOffset, y: 0), animated: true)
            if let button = self.weekDayStackView.subviews[Int(offset)+1] as? UIButton {
                button.setTitleColor(.green, for: .normal)
            }
        }
    }
    
    private func setupButtonFeature() {
        self.newWebtoonButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.everydayPlusButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.mondayButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.tuesdayButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.wednesdayButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.thursdayButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.fridayButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.saturdayButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.sundayButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
        self.finishButton.addTarget(self, action: #selector(moveToSpecificDay(sender: )), for: .touchUpInside)
    }
    
    @objc
    private func moveToSpecificDay(sender: UIButton) {
        var request = WebtoonHome.WebtoonList.Request.defaultRequest
        switch sender {
        case newWebtoonButton:
            request.updateDay = .new
        case everydayPlusButton:
            request.updateDay = .everyDayPlus
        case mondayButton:
            request.updateDay = .mon
        case tuesdayButton:
            request.updateDay = .tue
        case wednesdayButton:
            request.updateDay = .wed
        case thursdayButton:
            request.updateDay = .thu
        case fridayButton:
            request.updateDay = .fri
        case saturdayButton:
            request.updateDay = .sat
        case sundayButton:
            request.updateDay = .sun
        case finishButton:
            request.updateDay = .finished
        default:
            break
        }
        interactor?.fetchSpecificDayWebtoons(request: request,
                                             isButtonPress: true)
    }
    
    func fetchTodayWebtoon() {
        let request = WebtoonHome.WebtoonList.Request(page: 0,
                                                      perPage: Int(Int16.max),
                                                      service: .naver,
                                                      updateDay: Date.makeTodayWeekday())
        interactor?.fetchSpecificDayWebtoons(request: request,
                                             isButtonPress: true)
        interactor?.fetchRecommandWebtoons()
    }
    
    func displayRecommandWebtoon(viewModels: [WebtoonHome.WebtoonList.ViewModel]) {
        DispatchQueue.main.async { [weak self] in
            guard let self = self else { return }
            self.insertRecommandView(models: viewModels)
        }
    }
    
    private func applyTopEventGradient() {
        topEventStackView.subviews.forEach {
            let gradient: CAGradientLayer = .makeGreenGradient()
            gradient.frame = $0.bounds
            $0.layer.insertSublayer(gradient, at: 0)
        }
    }
    
    private func insertRecommandView(models: [WebtoonHome.WebtoonList.ViewModel]) {
        topEventStackView.subviews.forEach { $0.removeFromSuperview() }
        models.forEach { model in
            let frameView = {
                let view = UIView()
                view.translatesAutoresizingMaskIntoConstraints = false
                view.backgroundColor = .green
                view.layer.borderWidth = 3
                view.layer.borderColor = UIColor.white.cgColor
                return view
            }()
            topEventStackView.addArrangedSubview(frameView)
            NSLayoutConstraint.activate([frameView.widthAnchor.constraint(equalTo: self.view.safeAreaLayoutGuide.widthAnchor),
                                         frameView.heightAnchor.constraint(equalToConstant: 200)])
            UIImage.loadImage(from: model.img) { image in
                DispatchQueue.main.async {
                    guard let image = image else { return }
                    let resizedImage = UIImage.resizeImage(image: image, newSize: CGSize(width: 200, height: 200))
                    let imageView = {
                        let imageView = UIImageView(image: resizedImage)
                        imageView.translatesAutoresizingMaskIntoConstraints = false
                        return imageView
                    }()
                    frameView.addSubview(imageView)
                    let title: UILabel = {
                        let label = UILabel()
                        label.translatesAutoresizingMaskIntoConstraints = false
                        label.text = model.title
                        label.font = .makeCrisisKRFont(size: 25)
                        label.textColor = .white
                        return label
                    }()
                    frameView.addSubview(title)
                    NSLayoutConstraint.activate([imageView.leadingAnchor.constraint(equalTo: frameView.leadingAnchor, constant: 20),
                                                 imageView.centerYAnchor.constraint(equalTo: frameView.centerYAnchor),
                                                 title.trailingAnchor.constraint(equalTo: frameView.trailingAnchor, constant: -30),
                                                 title.bottomAnchor.constraint(equalTo: frameView.bottomAnchor, constant: -10)])
                }
            }?.resume()
        }
    }
    
    func disableAllButton() {
        DispatchQueue.main.async {
            self.weekDayStackView.subviews.forEach {
                if let button = $0 as? UIButton {
                    button.setTitleColor(.black, for: .normal)
                }
            }
        }
    }
    
    func resetCollectionView(heightConstraint: CGFloat?, targetView: UICollectionView?) {
        if let heightConstraint = heightConstraint,
           let targetView = targetView {
            self.currentCollectionHeightConstraint?.isActive = false
            self.currentCollectionHeightConstraint = targetView.heightAnchor.constraint(equalToConstant: heightConstraint)
            self.currentCollectionHeightConstraint?.isActive = true
        }
    }
    
    func displayWebtoonList(viewModels: [WebtoonHome.WebtoonList.ViewModel], updateDay: UpdateDay) {
        switch updateDay {
        case .new:
            self.newWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.newWebtoonCollection.reloadData()
                let heightConstraint = self?.newWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.newWebtoonCollection)
            }
        case .everyDayPlus:
            self.everyDayPlusWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.everyDayPlusWebtoonCollection.reloadData()
                let heightConstraint = self?.everyDayPlusWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.everyDayPlusWebtoonCollection)
            }
        case .mon:
            self.mondayWebtoonDiffableDatasource.updateCollectionViewData(newData: viewModels)
            DispatchQueue.main.async { [weak self] in
                let heightConstraint = self?.mondayWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.mondayWebtoonCollection)
            }
        case .tue:
            self.tuesdayWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.tuesdayWebtoonCollection.reloadData()
                let heightConstraint = self?.tuesdayWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.tuesdayWebtoonCollection)
            }
        case .wed:
            self.wednesdayWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.wednesdayWebtoonCollection.reloadData()
                let heightConstraint = self?.wednesdayWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.wednesdayWebtoonCollection)
            }
        case .thu:
            self.thursdayWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.thursdayWebtoonCollection.reloadData()
                let heightConstraint = self?.thursdayWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.thursdayWebtoonCollection)
            }
        case .fri:
            self.fridayWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.fridayWebtoonCollection.reloadData()
                let heightConstraint = self?.fridayWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.fridayWebtoonCollection)
            }
        case .sat:
            self.saturdayWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.saturdayWebtoonCollection.reloadData()
                let heightConstraint = self?.saturdayWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.saturdayWebtoonCollection)
            }
        case .sun:
            self.sundayWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.sundayWebtoonCollection.reloadData()
                let heightConstraint = self?.sundayWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.sundayWebtoonCollection)
            }
        case .finished:
            self.finishWebtoonDataSource.update(dataSource: viewModels)
            DispatchQueue.main.async { [weak self] in
                self?.finishWebtoonCollection.reloadData()
                let heightConstraint = self?.finishWebtoonCollection.collectionViewLayout.collectionViewContentSize.height
                self?.resetCollectionView(heightConstraint: heightConstraint, targetView: self?.finishWebtoonCollection)
            }
        }
    }
}

extension WebtoonHomeViewController: ScrollViewPositionChecker {
    func updateCurrentUpdateday(offset: CGFloat) {
        let fetchTargetIndex = floor(Double(offset/self.view.safeAreaLayoutGuide.layoutFrame.width))
        let targetDay = UpdateDay.makeIntToUpdateDay(value: Int(fetchTargetIndex))
        interactor?.updateCurrent(updateDay: targetDay)
        disableAllButton()
        DispatchQueue.main.async { [weak self] in
            if let button = self?.weekDayStackView.subviews[Int(fetchTargetIndex)+1] as? UIButton {
                button.setTitleColor(.green, for: .normal)
            }
        }
    }
    
    func fetchWebtoons(nextPostion: CGFloat, scrollDirection: ScrollDirection) {
        var fetchTargetIndex: Double = -1
        let buttonUpdateIndex: Double = round(Double(nextPostion/self.view.safeAreaLayoutGuide.layoutFrame.width))
        if scrollDirection == .right {
            fetchTargetIndex = ceil(Double(nextPostion/self.view.safeAreaLayoutGuide.layoutFrame.width))
        } else if scrollDirection == .left {
            fetchTargetIndex = floor(Double(nextPostion/self.view.safeAreaLayoutGuide.layoutFrame.width))
        }
        let targetDay = UpdateDay.makeIntToUpdateDay(value: Int(fetchTargetIndex))
        let request = WebtoonHome.WebtoonList.Request(page: 0,
                                                      perPage: Int(Int16.max),
                                                      service: .naver,
                                                      updateDay: targetDay)
        interactor?.fetchSpecificDayWebtoons(request: request,
                                             isButtonPress: false)
        disableAllButton()
        DispatchQueue.main.async { [weak self] in
            if let button = self?.weekDayStackView.subviews[Int(buttonUpdateIndex)+1] as? UIButton {
                button.setTitleColor(.green, for: .normal)
            }
        }
    }
}
